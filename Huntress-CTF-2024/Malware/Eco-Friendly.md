# Eco-Friendly

![image](https://github.com/user-attachments/assets/077f068b-2666-4476-93d8-46f076215aa4)

Download: [eco_friendly](https://raw.githubusercontent.com/LazyTitan33/CTF-Writeups/refs/heads/main/Huntress-CTF-2024/challenge-files/eco_friendly)

## My Solution

Reading the file, we can see it passing a very long blob to IEX:  

![image](https://github.com/user-attachments/assets/e302210a-5d44-4d4e-84a1-c93f2c394305)

After a few lines, we can see it grabbing letters from Environment variables and building a payload:  

![image](https://github.com/user-attachments/assets/062049b0-b6cd-4765-aaa7-9b6e07f3a7a1)

I changed that into an echo and ran it:  

![image](https://github.com/user-attachments/assets/d3c2c288-7dd4-4049-9b72-119aebb7df19)

This created a 2ndstage.ps1 which did the same thing, but when trying to repeat the tactic of replacing IEX with echo, we get a bunch of errors:  

![image](https://github.com/user-attachments/assets/c9d2c959-9f22-453f-a79d-efc49e775de6)

This is because, as we can see, the Environment variable names are mistyped. Doing a find a replace, we eventually correct it and move from a 2nd stage to 3rd stage. But when running the 3rd stage we get another set of errors:  

![image](https://github.com/user-attachments/assets/f0e20d8e-38da-4ea3-b3d7-0b26cf0330ef)

This keeps repeating a bunch of times until we correct all the misspelled environment variables. I did this manually as I couldn't think of a better way. We eventually reach this code stage:  

```powershell

echo ('{39}{23}{26}{13}{21}{16}{17}{14}{27}{9}{22}{3}{12}{1}{5}{20}{8}{38}{37}{7}{30}{6}{34}{11}{18}{4}{36}{19}{0}{24}{28}{32}{40}{35}{31}{25}{29}{33}{2}{15}{10}' `
-f [char]55,$env:ComSpec[22],[char]54,[char]52,`
$env:public[11],$env:ProgramFiles[14],[char]56,[char]53,$env:ComSpec[15],$env:public[11],[char]125,`
$env:Comspec[22],$env:Comspec[17],[char]102,[char]123,$env:Comspec[17],$env:ProgramFiles[8],`
$env:CommonProgramFiles[6],$env:public[11],[char]55,[char]49,$env:ProgramFiles[13],$env:ProgramData[11],`
[char]35,$env:Comspec[18],$env:ComSpec[17],$env:CommonProgramFiles[10],[char]56,`
$env:Comspec[18],[char]57,$env:Comspec[18],$env:Comspec[18],$env:public[5],`
$env:CommonProgramW6432[8],[char]55,[char]49,[char]102,[char]57,[char]48,$env:CommonProgramW6432[23],[char]53)
```
And we get our flag:  

![image](https://github.com/user-attachments/assets/63befe95-0055-479a-a3f7-609f1456ec6b)

`flag{8ba43de1e095287dbbf7722e51239a63}`
