# Strange Calc

![image](https://github.com/user-attachments/assets/691633b7-429c-4b2c-85db-52f5f576c521)

Download: [calc.zip](https://raw.githubusercontent.com/LazyTitan33/CTF-Writeups/refs/heads/main/Huntress-CTF-2024/challenge-files/calc.zip)

## My Solution

We start by analyzing the file and seeing that it is UPX compressed.  

![image](https://github.com/user-attachments/assets/74a29a47-252a-41da-a379-4a41911c0bb8)

We use `upx` command with the `-d` argument to decompress it:  

![image](https://github.com/user-attachments/assets/c8446eef-b363-409b-b2a1-e6c3c250acfe)

Considering I did this challenge via dynamic analysis, decompressing it isn't strictly necessary but it's good to know.

I moved to my [CommandoVM](https://github.com/mandiant/commando-vm) and started up [procmon](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon) to see what the file was doing when being executed:  

![image](https://github.com/user-attachments/assets/06acf780-43c5-44d8-be57-71614d842f2b)

We can see it creating a bunch of `.jse` files and then erroring out.

![image](https://github.com/user-attachments/assets/dc25f319-69cf-4442-98f2-e4976e36dfa6)

We can see the files it generated in our current working folder:  

![image](https://github.com/user-attachments/assets/1bc01f13-1bc0-42c1-911c-e641d28c6ef7)

Opening one of these files shows garbage looking text.

![image](https://github.com/user-attachments/assets/6e4c53b2-3bee-48f9-8a2d-d728bfaf6a1c)

These files are Encoded JScript that can be decoded. I used the [scrdec18-VC8.exe](https://gist.github.com/bcse/1834878) binary to decode them.

![image](https://github.com/user-attachments/assets/0f0445b5-2e4a-4f10-9d09-87f691234895)

And now we have human readable javascript code:  

![image](https://github.com/user-attachments/assets/bcad7670-6e0d-4575-abad-02e5847fded0)

After prettfying it a bit, it looks like this:  

```javascript
function a(b) {
    var c = "", d = b.split("\n");
    for (var e = 0; e < d.length; e++) {
        var f = d[e].replace(/^\s+|\s+$/g, '');
        if (f.indexOf("begin") === 0 || f.indexOf("end") === 0 || f === "") continue;
        var g = (f.charCodeAt(0) - 32) & 63;
        for (var h = 1; h < f.length; h += 4) {
            if (h + 3 >= f.length) break;
            var i = (f.charCodeAt(h) - 32) & 63,
                j = (f.charCodeAt(h + 1) - 32) & 63,
                k = (f.charCodeAt(h + 2) - 32) & 63,
                l = (f.charCodeAt(h + 3) - 32) & 63;
            c += String.fromCharCode((i << 2) | (j >> 4));
            if (h + 2 < f.length - 1) c += String.fromCharCode(((j & 15) << 4) | (k >> 2));
            if (h + 3 < f.length - 1) c += String.fromCharCode(((k & 3) << 6) | l);
        }
    }
    console.log(c);
    return c.substring(0, g);
}

var m = "begin 644 -\nG9FQA9WLY.3(R9F(R,6%A9C$W-3=E,V9D8C(X9#<X.3!A-60Y,WT*\n`\nend";
var n = a(m);
```

I removed the bits that we don't care about where it creates a local administrator. Sneaky, good thing we ran it in a contained VM where it doesn't matter.

I also added a Console.log on the `c` variable which seemed to be the important bit.

We can use [this](https://onecompiler.com/javascript/) online tool to run it safely and get our flag:  

![image](https://github.com/user-attachments/assets/e8755994-7cf0-4c95-95e9-78a13cd1f692)

This one is safe so you could also run it in any browser's console window, but other code may do other things, so it's better to have the habbit of running it in a sandbox.

`flag{9922fb21aaf1757e3fdb28d7890a5d93}`

