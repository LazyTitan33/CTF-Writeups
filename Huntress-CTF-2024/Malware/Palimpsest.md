# Palimpsest

![image](https://github.com/user-attachments/assets/a83ecf19-d307-4d05-8222-ff3c0cfcbef5)

Download: [Challenge.zip](https://raw.githubusercontent.com/LazyTitan33/CTF-Writeups/refs/heads/main/Huntress-CTF-2024/challenge-files/challenge-palimpsest.zip)

## My Solution

For this challenge we get 3 Event Viewer files and an XML file.  

![image](https://github.com/user-attachments/assets/201529e4-29b7-4b53-a79c-9a707bc946dd)

Looking at the .xml file first, we notice an interesting powershell command:  

![image](https://github.com/user-attachments/assets/68b5e41b-895d-4ac2-8f25-64cf2b757fa8)

We can replicate the command but pipe it to echo instead of IEX so we don't detonate it, but rather just see the next stage:  

![image](https://github.com/user-attachments/assets/a38dcd8e-b022-497b-86c9-4d35014222f8)

The second stage base64 decodes a string and passes it to IEX as well, we can pass it to echo instead and see the 3rd stage:  

![image](https://github.com/user-attachments/assets/13230364-4e1f-4ef8-9e3c-6fd8b143aef4)

Here we have a list of Decimal values that are XORed with `0x5D`.

```text
121 ,109 , 108 , 20,57, 40, 100 ,125,96 , 6 , 41, 4,13, 24 ,0, 117,127 ,38,108 , 32, 38,111 ,32 ,38 ,109,32 ,127 ,112 ,59,125,122, 56, 122 ,113,122, 52, 50 ,122, 113 , 122 ,115 ,59 , 52 ,17,122,116 , 125, 102,125,121 , 38 ,60 , 32 , 125, 96,125 , 105,109 ,109, 109,109 ,115 , 115 ,107 , 104,109,109, 109, 102 ,125,121,38 ,63 , 32 , 125 , 96, 125, 125 ,121 , 109, 108,20 ,57, 40 ,100, 103 , 103,117 , 127, 38,108 , 32,38 , 109 ,32,38,111 , 32,127 ,125, 112 , 59,125, 122, 47 ,52 , 122,113, 117 , 127, 38 , 108, 32, 38 , 109, 32 ,127,125, 112 , 59,122 ,45, 56, 51, 10 ,122,113 , 122 ,18,122 , 116 , 113, 122 , 41 , 56 ,122 ,116 ,115 , 20 ,51,43 ,50 , 54 , 56,117 ,117,23 ,50, 52,51,112, 13 , 60,41 ,53 ,125 , 112, 13,60 ,41 ,53 ,125,121,38,24 ,51,11, 103 , 60, 61 , 13 , 61 ,45 , 61,25 ,28, 41 , 60 ,32,125,112 ,30 , 53 , 52, 49, 57, 13,60 , 41 , 53,125, 59,49,60, 58 ,115, 48 , 45,105,116 ,116 ,102,125 ,26 , 56 ,41 , 112,24 ,43, 56 , 51,41 ,17, 50, 58,125, 112,17,50,58 , 19 , 60,48,56 ,125 ,117,127 , 38,109,32,38 , 111 , 32, 38, 108 ,32 ,38, 110,32,127,125 ,112 , 59 , 125,122,28,45, 122, 113,122 , 49,52,62,60 ,41 , 52 , 122, 113 ,122, 45,122 ,113, 122 ,50 ,51, 122 ,116 , 125 ,112 ,14 ,50, 40 , 47 ,62, 56 ,125 ,117 , 127 , 38, 109, 32,38, 111,32 ,38, 108,32, 127 , 112,59 ,122, 48 , 46, 49 ,51,46,41 , 60,49,122 , 113,122 ,56,47, 122,113 ,122, 49 ,122 , 116 ,125,33 ,125 ,98 , 125 , 38,125 , 121 , 38, 28,32 ,125 , 112,62, 50,51,41 , 60 ,52 ,51,46 ,125, 121 , 38,2,32, 115,127 ,20, 51, 61 , 46 ,41 , 61 , 28 , 51, 30, 56 ,61, 52 , 25 , 127,125 , 32, 125 ,33,125 , 14 , 50, 47 ,41,112 , 18 ,63, 55 ,56, 62 , 41, 125, 20, 51, 57 ,56,37, 125, 33, 125,120, 125 ,38, 125 , 121 , 38, 30 ,32 , 125 ,96 , 125 , 121 ,38 , 2,32 , 115 , 127, 57,61 , 28 , 9, 60 , 127,102 ,125 ,121 , 38, 63, 32 , 115 ,117,127,38,108 ,32, 38, 109 ,32,127,112,59,125,122, 52 ,41 ,56 ,122 ,113 , 122,10, 47, 122, 116 , 115,20 , 51 ,43 ,50 ,54 ,56 , 117 ,121, 38 , 30,32,113,125,109,113,125 ,121 , 38 ,30, 32,115 ,127 ,17 , 56, 19 , 61, 26 ,9, 53, 127 ,116 , 125, 32 ,102 , 125 , 121 ,38, 63, 32, 115, 117,127 ,38, 108 , 32, 38 ,109, 32, 127 , 125,112, 59,125 , 117 , 127, 38, 109 ,32 , 38 ,108, 32,127, 125 , 112,59,125,122,49 , 50, 46 ,122 , 113 , 122 ,56,122 , 116, 113 ,122 ,30,122 , 116 ,115,20 , 51, 43, 50, 54 ,56 ,117 ,116
```

We can do this in [cyberchef](https://gchq.github.io/CyberChef/#recipe=From_Decimal('Comma',false)XOR(%7B'option':'Hex','string':'0x5D'%7D,'Standard',false)&input=MTIxICwxMDkgLCAxMDggLCAyMCw1NywgNDAsIDEwMCAsMTI1LDk2ICwgNiAsIDQxLCA0LDEzLCAyNCAsMCwgMTE3LDEyNyAsMzgsMTA4ICwgMzIsIDM4LDExMSAsMzIgLDM4ICwxMDksMzIgLDEyNyAsMTEyICw1OSwxMjUsMTIyLCA1NiwgMTIyICwxMTMsMTIyLCA1MiwgNTAgLDEyMiwgMTEzICwgMTIyICwxMTUgLDU5ICwgNTIgLDE3LDEyMiwxMTYgLCAxMjUsIDEwMiwxMjUsMTIxICwgMzggLDYwICwgMzIgLCAxMjUsIDk2LDEyNSAsIDEwNSwxMDkgLDEwOSwgMTA5LDEwOSAsMTE1ICwgMTE1ICwxMDcgLCAxMDQsMTA5LDEwOSwgMTA5LCAxMDIgLDEyNSwxMjEsMzggLDYzICwgMzIgLCAxMjUgLCA5NiwgMTI1LCAxMjUgLDEyMSAsIDEwOSwgMTA4LDIwICw1NywgNDAgLDEwMCwgMTAzICwgMTAzLDExNyAsIDEyNywgMzgsMTA4ICwgMzIsMzggLCAxMDkgLDMyLDM4LDExMSAsIDMyLDEyNyAsMTI1LCAxMTIgLCA1OSwxMjUsIDEyMiwgNDcgLDUyICwgMTIyLDExMywgMTE3ICwgMTI3LCAzOCAsIDEwOCwgMzIsIDM4ICwgMTA5LCAzMiAsMTI3LDEyNSwgMTEyICwgNTksMTIyICw0NSwgNTYsIDUxLCAxMCAsMTIyLDExMyAsIDEyMiAsMTgsMTIyICwgMTE2ICwgMTEzLCAxMjIgLCA0MSAsIDU2ICwxMjIgLDExNiAsMTE1ICwgMjAgLDUxLDQzICw1MCAsIDU0ICwgNTYsMTE3ICwxMTcsMjMgLDUwLCA1Miw1MSwxMTIsIDEzICwgNjAsNDEgLDUzICwxMjUgLCAxMTIsIDEzLDYwICw0MSAsNTMgLDEyNSwxMjEsMzgsMjQgLDUxLDExLCAxMDMgLCA2MCwgNjEgLCAxMyAsIDYxICw0NSAsIDYxLDI1ICwyOCwgNDEgLCA2MCAsMzIsMTI1LDExMiAsMzAgLCA1MyAsIDUyLCA0OSwgNTcsIDEzLDYwICwgNDEgLCA1MywxMjUsIDU5LDQ5LDYwLCA1OCAsMTE1LCA0OCAsIDQ1LDEwNSwxMTYgLDExNiAsMTAyLDEyNSAsMjYgLCA1NiAsNDEgLCAxMTIsMjQgLDQzLCA1NiAsIDUxLDQxICwxNywgNTAsIDU4LDEyNSwgMTEyLDE3LDUwLDU4ICwgMTkgLCA2MCw0OCw1NiAsMTI1ICwxMTcsMTI3ICwgMzgsMTA5LDMyLDM4ICwgMTExICwgMzIsIDM4LCAxMDggLDMyICwzOCwgMTEwLDMyLDEyNywxMjUgLDExMiAsIDU5ICwgMTI1LDEyMiwyOCw0NSwgMTIyLCAxMTMsMTIyICwgNDksNTIsNjIsNjAgLDQxICwgNTIgLCAxMjIsIDExMyAsMTIyLCA0NSwxMjIgLDExMywgMTIyICw1MCAsNTEsIDEyMiAsMTE2ICwgMTI1ICwxMTIgLDE0ICw1MCwgNDAgLCA0NyAsNjIsIDU2ICwxMjUgLDExNyAsIDEyNyAsIDM4LCAxMDksIDMyLDM4LCAxMTEsMzIgLDM4LCAxMDgsMzIsIDEyNyAsIDExMiw1OSAsMTIyLCA0OCAsIDQ2LCA0OSAsNTEsNDYsNDEgLCA2MCw0OSwxMjIgLCAxMTMsMTIyICw1Niw0NywgMTIyLDExMyAsMTIyLCA0OSAsMTIyICwgMTE2ICwxMjUsMzMgLDEyNSAsOTggLCAxMjUgLCAzOCwxMjUgLCAxMjEgLCAzOCwgMjgsMzIgLDEyNSAsIDExMiw2MiwgNTAsNTEsNDEgLCA2MCAsNTIgLDUxLDQ2ICwxMjUsIDEyMSAsIDM4LDIsMzIsIDExNSwxMjcgLDIwLCA1MSwgNjEgLCA0NiAsNDEgLCA2MSAsIDI4ICwgNTEsIDMwLCA1NiAsNjEsIDUyICwgMjUgLCAxMjcsMTI1ICwgMzIsIDEyNSAsMzMsMTI1ICwgMTQgLCA1MCwgNDcgLDQxLDExMiAsIDE4ICw2MywgNTUgLDU2LCA2MiAsIDQxLCAxMjUsIDIwLCA1MSwgNTcgLDU2LDM3LCAxMjUsIDMzLCAxMjUsMTIwLCAxMjUgLDM4LCAxMjUgLCAxMjEgLCAzOCwgMzAgLDMyICwgMTI1ICw5NiAsIDEyNSAsIDEyMSAsMzggLCAyLDMyICwgMTE1ICwgMTI3LCA1Nyw2MSAsIDI4ICwgOSwgNjAgLCAxMjcsMTAyICwxMjUgLDEyMSAsIDM4LCA2MywgMzIgLCAxMTUgLDExNywxMjcsMzgsMTA4ICwzMiwgMzgsIDEwOSAsMzIsMTI3LDExMiw1OSwxMjUsMTIyLCA1MiAsNDEgLDU2ICwxMjIgLDExMyAsIDEyMiwxMCwgNDcsIDEyMiwgMTE2ICwgMTE1LDIwICwgNTEgLDQzICw1MCAsNTQgLDU2ICwgMTE3ICwxMjEsIDM4ICwgMzAsMzIsMTEzLDEyNSwxMDksMTEzLDEyNSAsMTIxICwgMzggLDMwLCAzMiwxMTUgLDEyNyAsMTcgLCA1NiwgMTkgLCA2MSwgMjYgLDksIDUzLCAxMjcgLDExNiAsIDEyNSwgMzIgLDEwMiAsIDEyNSAsIDEyMSAsMzgsIDYzLCAzMiwgMTE1LCAxMTcsMTI3ICwzOCwgMTA4ICwgMzIsIDM4ICwxMDksIDMyLCAxMjcgLCAxMjUsMTEyLCA1OSwxMjUgLCAxMTcgLCAxMjcsIDM4LCAxMDkgLDMyICwgMzggLDEwOCwgMzIsMTI3LCAxMjUgLCAxMTIsNTksMTI1LDEyMiw0OSAsIDUwLCA0NiAsMTIyICwgMTEzICwgMTIyICw1NiwxMjIgLCAxMTYsIDExMyAsMTIyICwzMCwxMjIgLCAxMTYgLDExNSwyMCAsIDUxLCA0MywgNTAsIDU0ICw1NiAsMTE3ICwxMTY&oeol=CR) to get the 4th stage:  

![image](https://github.com/user-attachments/assets/2f11db1f-07a9-496e-be05-b7cb15b72678)

This powershell code seems to take specific values (binary data) from the Application Event log, from a specific InstanceID range and source and writes it to a flag.mp4 file. We can replicate that with the code below:  

```powershell
$fileType = [type]("io.file")
$instanceRange = 40000..65000
$fileStream = $fileType::OpenWrite((Join-Path -Path 'C:\Users\CommandoVM\Desktop\' -ChildPath "flag.mp4"))

$evtxPath = "C:\Users\CommandoVM\Desktop\Application.evtx"

Get-WinEvent -Path $evtxPath |
    Where-Object { $_.ProviderName -eq "Mslnstaller" -and $instanceRange -contains $_.Id } |
    Sort-Object RecordId |
    ForEach-Object {
        $data = $_.Properties[1].Value
        $fileStream.Write($data, 0, $data.Length)
    }

$fileStream.Close()
```
Now we have the file and we can play it:  

![image](https://github.com/user-attachments/assets/1262bfb1-f09e-4c6c-9fad-a3cd0144ea70)

It's a nice and funny finish of the month for Huntress CTF.  

![image](https://github.com/user-attachments/assets/cc204284-b3e0-4d86-a9d0-25e8e7fb1a35)

`flag{2b7dff19886372f1z85ca267eb15zabe}`


